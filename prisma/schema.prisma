
generator client {
  provider = "prisma-client"
  output   = "../generated/prisma"
}

datasource db {
  provider = "postgresql"
}

enum MonitorStatus{
  UP
  DOWN
}

model User{
  id String @id @default(uuid())
  keycloakId String @unique
  name String?
  monitors Monitor[]
createdAt DateTime
updatedAt DateTime
}

model Monitor{
  id String @id @default(uuid())
  userId String
  name String
  url String
  method String @default("GET")
  timeoutMs Int
  enabled Boolean @default(true)
  user User @relation(fields: [userId],references: [id])
  results CheckResult[]
  incidents Incident[]
  monitorSchedule MonitorSchedule?
  createdAt DateTime
  updatedAt DateTime
}

model MonitorSchedule{
  id String @id @default(uuid())
  monitorId String @unique
  intervalSeconds Int
  queueName String @default("monitor-checks")
  monitor Monitor @relation(fields: [monitorId],references: [id])
  createdAt DateTime
  updatedAt DateTime
}

model CheckResult{
  id String @id @default(uuid())
  monitorId String
  status MonitorStatus
  statusCode Int?
  responseTime Int?
  errorMessage String?
  checkedAt DateTime    @default(now())
  monitor Monitor @relation(fields: [monitorId],references: [id])
  @@index([monitorId,checkedAt])
}

model Incident{
  id String @id @default(uuid())
  monitorId String
  startedAt DateTime
  resolvedAt DateTime
  reason String?
  monitor Monitor @relation(fields: [monitorId],references: [id])
  @@index([monitorId,startedAt])
}